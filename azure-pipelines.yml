trigger:
- master

pool:
  name: $(Agent)

steps:
- script: echo "üöÄ Deploy to AKS starting..."
  displayName: 'Print Deployment Start'

# Optional: Install Azure CLI on the self-hosted agent (if not pre-installed)
- task: Bash@3
  displayName: 'Install Azure CLI (if not present)'
  inputs:
    targetType: 'inline'
    script: |
      if ! command -v az &> /dev/null
      then
        echo "Azure CLI not found. Installing..."
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      else
        echo "‚úÖ Azure CLI already installed: $(az version)"
      fi

# Use Azure CLI to get AKS credentials
- task: AzureCLI@2
  inputs:
    azureSubscription: 'Azure service' 
    scriptType: 'bash'                 
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "üîê Logging in and setting AKS credentials..."
      az aks get-credentials \
        --resource-group $(resource-group) \
        --name $(KubernetesCluster-Name) \
        --overwrite-existing
  displayName: 'Get AKS Credentials'
- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: 'latest'
# Deploy Kubernetes manifest
- task: KubernetesManifest@1
  inputs:
    action: 'deploy'
    connectionType: '$(ServiceConnection)'
    azureSubscriptionConnection: '$(AzureSubscriptionConnection)'
    azureResourceGroup: '$(resource-group)'
    kubernetesCluster: '$(KubernetesCluster-Name)'
    namespace: '$(NameSpace)'
    manifests: '$(Manifests)'
  displayName: 'Deploy to AKS'
